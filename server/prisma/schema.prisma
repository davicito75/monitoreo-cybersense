generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Check {
  id        Int      @id @default(autoincrement())
  monitorId Int
  status    String
  latencyMs Int?
  error     String?
  createdAt DateTime @default(now())
  Monitor   Monitor  @relation(fields: [monitorId], references: [id])
}

model Incident {
  id        Int       @id @default(autoincrement())
  monitorId Int
  startedAt DateTime
  endedAt   DateTime?
  status    String
  Monitor   Monitor   @relation(fields: [monitorId], references: [id])
}

model MaintenanceMonitor {
  maintenanceId     Int
  monitorId         Int
  MaintenanceWindow MaintenanceWindow @relation(fields: [maintenanceId], references: [id], onDelete: Cascade)
  Monitor           Monitor           @relation(fields: [monitorId], references: [id])

  @@id([maintenanceId, monitorId])
}

model MaintenanceWindow {
  id                 Int                  @id @default(autoincrement())
  name               String
  description        String?
  startTime          DateTime
  endTime            DateTime
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  MaintenanceMonitor MaintenanceMonitor[]
}

model Monitor {
  id                 Int                  @id @default(autoincrement())
  name               String
  type               String
  urlOrHost          String
  port               Int?
  intervalSec        Int                  @default(60)
  retries            Int                  @default(1)
  timeoutMs          Int                  @default(5000)
  expectedStatus     Int?
  contentRegex       String?
  mssqlUsername      String?
  mssqlPassword      String?
  mssqlDatabase      String?
  mssqlQuery         String?
  notifyOnDown       Boolean              @default(true)
  isPaused           Boolean              @default(false)
  sslCertExpiry      DateTime?
  sslDaysUntilExpiry Int?
  sslIssuer          String?
  sslValid           Boolean?
  displayOrder       Int                  @default(0)
  createdAt          DateTime             @default(now())
  Check              Check[]
  Incident           Incident[]
  MaintenanceMonitor MaintenanceMonitor[]
  MonitorStats       MonitorStats[]
  MonitorTag         MonitorTag[]
  UserMonitor        UserMonitor[]
}

model MonitorStats {
  id           Int      @id @default(autoincrement())
  monitorId    Int
  date         DateTime
  avgLatencyMs Int?
  minLatencyMs Int?
  maxLatencyMs Int?
  upCount      Int      @default(0)
  downCount    Int      @default(0)
  totalChecks  Int      @default(0)
  uptime       Float    @default(0.0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  Monitor      Monitor  @relation(fields: [monitorId], references: [id], onDelete: Cascade)

  @@unique([monitorId, date])
  @@index([monitorId, date])
}

model MonitorTag {
  monitorId Int
  tagId     Int
  createdAt DateTime @default(now())
  Monitor   Monitor  @relation(fields: [monitorId], references: [id], onDelete: Cascade)
  Tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([monitorId, tagId])
}

model NotificationConfig {
  id                   Int      @id @default(autoincrement())
  pushEnabled          Boolean  @default(true)
  notifyOnDown         Boolean  @default(true)
  notifyOnUp           Boolean  @default(true)
  notifyOnSlowResponse Boolean  @default(true)
  notifyOnSSLExpiry    Boolean  @default(true)
  sslExpiryDays        Int      @default(30)
  soundEnabled         Boolean  @default(true)
  badgeEnabled         Boolean  @default(true)
  quietHoursEnabled    Boolean  @default(false)
  quietHoursStart      String?
  quietHoursEnd        String?
  pushbulletEnabled    Boolean  @default(false)
  pushbulletToken      String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime
}

model PushSubscription {
  id        Int      @id @default(autoincrement())
  userId    Int
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id])

  @@unique([endpoint, userId])
}

model Tag {
  id         Int          @id @default(autoincrement())
  name       String       @unique
  color      String       @default("#3B82F6")
  createdAt  DateTime     @default(now())
  MonitorTag MonitorTag[]
}

model User {
  id               Int                @id @default(autoincrement())
  email            String             @unique
  passwordHash     String
  role             String             @default("READ_ONLY")
  pushbulletToken  String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  PushSubscription PushSubscription[]
  UserMonitor      UserMonitor[]
}

model UserMonitor {
  userId    Int
  monitorId Int
  createdAt DateTime @default(now())
  Monitor   Monitor  @relation(fields: [monitorId], references: [id])
  User      User     @relation(fields: [userId], references: [id])

  @@id([userId, monitorId])
}
